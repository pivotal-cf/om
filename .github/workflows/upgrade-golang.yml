name: Upgrade Golang

concurrency: Upgrade Golang 2

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 0 * * 0'

jobs:
  upgrade-golang:
    runs-on: ubuntu-latest

    container:
      image: internalpcfplatformautomation/ci:testing

    defaults:
      run:
        shell: bash

    steps:
      - id: checkout-om
        name: Checkout Om
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          path: om

      - id: setup-go
        name: Setup latest Go
        uses: actions/setup-go@v5
        with:
          check-latest: true

      - id: upgrade-golang
        name: Upgrade Golang
        working-directory: om
        run: |
          version=$(go version | awk '{print $3}' | sed 's/go//')
          echo "Current go version: $version"
          go mod edit -go=$version
          go get -u -t ./...
          go mod tidy

      - id: create-pull-request
        name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          path: om
          author: tas-operability-bot <149723437+tas-operability-bot@users.noreply.github.com>
          committer: tas-operability-bot <149723437+tas-operability-bot@users.noreply.github.com>
          commit-message: Upgrade Golang
          title: Upgrade Golang
          branch: tmp/upgrade-golang
          branch-suffix: short-commit-hash
      
      - uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.create-pull-request.outputs.pull-request-number }}

FROM ubuntu:22.04

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install Squid and Kerberos dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        squid \
        krb5-user \
        krb5-kdc \
        libkrb5-dev \
        libgssapi-krb5-2 \
        && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create necessary directories
RUN mkdir -p /var/log/squid /var/spool/squid /etc/squid /run/squid && \
    chown -R proxy:proxy /var/log/squid /var/spool/squid /run/squid

# Find and create symlink for negotiate_kerberos_auth helper
# Different distributions put it in different locations
RUN HELPER_PATH=$(find /usr -name "negotiate_kerberos_auth" 2>/dev/null | head -1) && \
    if [ -n "$HELPER_PATH" ]; then \
        mkdir -p /usr/lib/squid && \
        ln -sf "$HELPER_PATH" /usr/lib/squid/negotiate_kerberos_auth && \
        echo "Found negotiate_kerberos_auth at: $HELPER_PATH"; \
    else \
        echo "Warning: negotiate_kerberos_auth not found. Squid may need to be built with Kerberos support."; \
    fi && \
    ls -la /usr/lib/squid/negotiate_kerberos_auth 2>/dev/null || true

# Expose Squid port
EXPOSE 3128

# Create startup script
RUN printf '#!/bin/sh\n\
# Remove any stale PID files\n\
rm -f /run/squid/squid.pid /run/squid.pid /var/run/squid.pid\n\
\n\
# Initialize cache directories\n\
echo "Initializing cache directories..."\n\
if [ ! -d /var/spool/squid/00 ]; then\n\
    # Try squid -z first\n\
    if su -s /bin/sh proxy -c "squid -z -f /etc/squid/squid.conf" 2>&1; then\n\
        echo "Cache directories created by squid -z"\n\
        sleep 1\n\
    else\n\
        echo "Warning: squid -z had issues, creating directories manually..."\n\
        # Create cache directories manually (16 subdirectories for ufs cache)\n\
        for dir in 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F; do\n\
            mkdir -p /var/spool/squid/$dir\n\
        done\n\
        chown -R proxy:proxy /var/spool/squid\n\
        echo "Cache directories created manually"\n\
    fi\n\
    # Remove PID file created by squid -z\n\
    rm -f /run/squid/squid.pid /run/squid.pid /var/run/squid.pid\n\
fi\n\
\n\
# Verify cache directories exist (with retry)\n\
retries=3\n\
while [ $retries -gt 0 ] && [ ! -d /var/spool/squid/00 ]; do\n\
    echo "Waiting for cache directories... ($retries retries left)"\n\
    sleep 1\n\
    retries=$((retries - 1))\n\
done\n\
\n\
if [ ! -d /var/spool/squid/00 ]; then\n\
    echo "ERROR: Failed to create cache directories!"\n\
    ls -la /var/spool/squid/\n\
    exit 1\n\
fi\n\
\n\
echo "Cache directories ready. Starting Squid..."\n\
# Start Squid in foreground\n\
exec squid -N -f /etc/squid/squid.conf\n\
' > /start-squid.sh && chmod +x /start-squid.sh

# Default command
CMD ["/start-squid.sh"]


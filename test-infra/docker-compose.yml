version: '3.8'

services:
  # Kerberos KDC (Key Distribution Center)
  kdc:
    image: tas-operability-docker-virtual.usw1.packages.broadcom.com/gcavalcante8808/krb5-server:latest
    container_name: om-test-kdc
    hostname: kdc.example.com
    environment:
      - KRB5_REALM=EXAMPLE.COM
      - KRB5_KDC=kdc.example.com
      - KRB5_ADMIN_PASSWORD=admin123
    ports:
      - "8088:88/udp"   # Kerberos (mapped to 8088 to avoid port conflicts)
      - "8088:88/tcp"   # Kerberos (mapped to 8088 to avoid port conflicts)
      - "749:749"       # Kerberos admin
      - "464:464/udp"   # kpasswd
      - "464:464/tcp"   # kpasswd
    volumes:
      - ./krb5/krb5.conf:/etc/krb5.conf:ro
      - kdc-data:/var/kerberos/krb5kdc
    networks:
      - om-test-network
    healthcheck:
      test: ["CMD", "kadmin.local", "-q", "list_principals"]
      interval: 10s
      timeout: 5s
      retries: 5

  # HTTP Proxy with Kerberos authentication
  proxy:
    build:
      context: .
      dockerfile: Dockerfile.squid-kerberos
    container_name: om-test-proxy
    hostname: proxy.example.com
    depends_on:
      kdc:
        condition: service_healthy
    environment:
      - REALM=EXAMPLE.COM
      - KDC_HOST=kdc.example.com
      - PROXY_HOST=proxy.example.com
    ports:
      - "3128:3128"   # HTTP proxy
    volumes:
      - ./squid/squid.conf:/etc/squid/squid.conf:ro
      - ./squid/krb5.keytab:/etc/squid/krb5.keytab:ro
      - ./krb5/krb5.conf:/etc/krb5.conf:ro
    networks:
      - om-test-network
    extra_hosts:
      - "kdc.example.com:172.20.0.2"


networks:
  om-test-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  kdc-data:

